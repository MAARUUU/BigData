# Установка Spark на Ubuntu
*Spark* - это фреймворк (ПО, объединяющее готовые компоненты большого программного проекта), который используют для параллельной обработки неструктурированных или слабоструктурированных данных.

![](https://bigdataschool.ru/wp-content/uploads/2019/10/spark0.png)

## Подключение к удалённому серверу
 
```shell
# базовая команда подключения
# remote_host - IP-адрес или доменное имя узла, к которому вы пытаетесь подключиться.
ssh remote_host 
# если сервер привязан к домену и есть какой-то пользователь
ssh user@domen
```

## Основные команды терминала Ubuntu
- `cp file.js /home/test/` — копирует файл по указанному пути
- `lsof -i -n -P` — посмотреть работающие порты
- `kill PID` — убить порт по его PID
- `curl url` — посылает get запрос по указанному `url`
- `wget url` — скачивает файл
- `unzip file` — распаковка zip-архивов
- `tar -zxvf file.tgz` — распаковка tgz-архивов
- `echo "Hello World!"` — вывести сообщение в консоль
- `echo "Hello" >> hello.js` — запишет строку `“Hello”` в файл `hello.js`
- `htop` — покажет запущенные процессы и загруженность системы
- `ls` — посмотреть список файлов и папок в текущей директории
- `ls -lah` — посмотреть список всех файлов и папок в текущей директории с указанием прав на запись/чтение и размера файлов
- `ll` — сокращённая запись `ls -lah`
- `cd /folder`  — перейти в нужную папку
- `cd ..` — перейти в предыдущую папку
- `mkdir name` — создать папку
- `touch name.js` — создать файл
- `cat index.html` — вывести код файла в терминал
- `rm -rf file.js` — удаление папки или файла
- `pwd` — вернёт путь к папке, в который мы в данный момент находимся
- `clear` — очистить консоль
- `mv main.js index.js` — команда для перемещения файла из одной папки в другую, но часто используется для переименования файла
- `tree` - показать дерево файлов и директорий, начиная от корня
- `clock -w` - сохранить системное время в BIOS
- `shutdown -h now` - Остановить систему
- `shutdown -r now` - перегрузить систему
- `logout` - выйти из системы

## Терминальный мультиплексор tmux
Tmux — это менеджер терминалов, который позволяет работать с несколькими сессиями в одном окне. То есть вместо нескольких открытых окон терминала — вы используете одно, которое можно делить на несколько окон.
![](https://static.1cloud.ru/img/support/377.png)
Киллер фича ти-макса — сохранение состояний подключений и процессов. После разрыва соединения с сервером вы подключаетесь, и все запущенные программы и процессы продолжают работать. Дополнительно можно работать совместно с другими в терминале, если все подключены к одной сессии.

### Установка и настройка Tmux
Устанавливается Tmux из стандартных репозиториев Linux:
```shell
apt-get install tmux
```
После установки рекомендуется сразу отредактировать конфигурационный файл tmux (/etc/tmux.conf) и внести следующие изменения:
```shell
set -g mouse on
```
Эта строчка кода позволит свободно перемещать границы разделения окон с помощью курсора мышки.
### *Работа с сессиями в Tmux*
Для создания рабочей сессии без идентификатора — достаточно ввести tmux в терминале. Будет создана сессия 0:
![](https://static.1cloud.ru/img/support/378.png)
Идентификатор сессии отображается внизу слева в квадратных скобках. Для создания именной сессии достаточно ввести следующую команду:
```shell
tmux new -s название сессии
```
Поскольку tmux завершает соединение с сохранением состояния сессии, правильным способом возобновить работу ти-макса будет его запуск командой:
```shell
tmux attach || tmux new
```
Просмотреть список созданных сессий можно командой:
```shell
tmux ls
```
Закрыть все сессии можно командой:
```shell
tmux kill-server
```
## Список часто используемых команд и хоткейсов Tmux
*Команды для управления сессиями:*
- `tmux new [имя_сеанса]` — начать новый сеанс. Имя_сеанса опционально;
- `tmux attach -t [имя_сеанса]` - подключиться к уже существующей сессии. Если имя заранее не было задано, тогда команда будет выглядить так: tmux attach -t 0;
- `tmux ls` — список открытых сессий Tmux;
- `kill-server` — остановить все запущенные сессии;
- `kill-session -t [имя_сеанса]` — завершить сессию;
- `list-clients -t [имя_сеанса]` — посмотреть клиентов, подключенных к сессии;
- `list-sessions` — вывести список всех запущенных сессий.

*Хоткейсы для управления окнами:*
- `Ctrl + b, c` — создать новое окно;
- `Ctrl + b, w` — просмотреть список окон;
- `Ctrl + b, n` — следующее окно;
- `Ctrl + b, p` — предыдущее окно;
- `Ctrl + b, w` — следующее окно;
- `Ctrl + b, номер окна (цифрой)` — переключиться на нужное окно;
- `Ctrl + b, “` — горизонтальное разделение окна;
- `Ctrl + b, %` — вертикальное разделение окна.

## Начальная настройка сервера Ubuntu

Когда вы впервые создаете новый сервер Ubuntu, необходимо выполнить ряд важных шагов по конфигурации в рамках базовой настройки. Эти шаги помогут повысить уровень безопасности и удобства работы с сервером и послужат прочной основой для последующих действий.

### *Шаг 1 — Вход с привилегиями root*
Чтобы войти на сервер, Нам нужно знать публичный IP-адрес вашего сервера. Также вам потребуется пароль или, если вы установили ключ SSH для аутентификации, приватный ключ для учетной записи root user. 
Если вы еще не подключились к серверу, выполните вход в систему как root user, используя следующую команду (замените выделенную часть команды на публичный IP-адрес вашего сервера):
```shell
ssh root@your_server_ip
```
### *Шаг 2 — Создание нового пользователя*
После входа в систему с правами root мы готовы добавить новую учетную запись пользователя. 
Этот пример создает нового пользователя с именем sammy:
```shell
adduser sammy
```
### *Шаг 3 — Предоставление административных прав*
Чтобы не выполнять выход из стандартной учетной записи и выполнять вход в систему с учетной записью root, мы можем настроить так называемого суперпользователя или добавить привилегии root для стандартной учетной записи. Это позволит нашему обычному пользователю запускать команды с правами администратора, указав слово sudo перед каждой командой.
Используя права root, запустите эту команду, чтобы добавить нового пользователя в группу *sudo* (замените выделенное имя пользователя на нового пользователя):
```shell
usermod -aG sudo sammy
```
### *Шаг 4 — Настройка базового брандмауэра*
OpenSSH, служба, позволяющая подключиться к нашему серверу сейчас, имеет профиль, зарегистрированный в UFW.

Чтобы увидеть это, можно ввести следующую команду:

```shell
ufw app list
```
Нам нужно убедиться в том, что брандмауэр разрешает подключения SSH, чтобы мы могли выполнить вход в следующий раз. Чтобы разрешить эти подключения, можно ввести следующее:
```shell
ufw allow OpenSSH
```
После этого мы можем активировать брандмауэр с помощью следующей команды:
```shell
ufw enable
```
Введите *y* и нажмите *ENTER*, чтобы продолжить. Чтобы увидеть, что подключения SSH разрешены, введите следующее:

```shell
ufw status
```
### *Шаг 5 — Активация внешнего доступа для стандартного пользователя*
Процесс настройки доступа SSH для нового пользователя зависит от того, использует ли учетная запись с правами root на сервере пароль или ключи SSH для аутентификации.

#### Если учетная запись root использует аутентификацию по паролю
Если вы выполнили вход в учетную запись root с помощью пароля, тогда для SSH активирована аутентификация по паролю. Вы можете использовать SSH для новой учетной записи пользователя, запустив новый сеанс терминала и используя SSH с новым именем:
```shell
ssh sammy@your_server_ip
```
После ввода пароля для обычного пользователя вы сможете выполнить вход. Если вам нужно запустить команду с правами администратора, введите sudo перед командой следующим образом:
```shell
sudo command_to_run
```

#### Если учетная запись root использует аутентификацию по ключу SSH
Если вы выполнили вход в учетную запись root с помощью ключей SSH, тогда аутентификация по паролю для SSH отключена. Вам потребуется добавить копию локального открытого ключа в файл ~/.ssh/authorized_keys нового пользователя для успешного входа.

Поскольку ваш открытый ключ уже включен в файл ~/.ssh/authorized_keys учетной записи root

Самый простой способ копирования файлов с правильным правами владения и разрешениями — воспользоваться командой rsync. Она будет копировать директорию .ssh пользователя root user, сохранит разрешения и изменит владельцев файлов, все в одной команде. Обязательно измените выделенные ниже части согласно имени вашего стандартного пользователя:

```shell
rsync --archive --chown=sammy:sammy ~/.ssh /home/sammy
```

Теперь откройте новый сеанс терминала на локальном компьютере и используйте SSH с вашим новым именем пользователя:

```shell
ssh sammy@your_server_ip
```

Вы должны выполнить вход в новую учетную запись без использования пароля. Если вам нужно запустить команду с правами администратора, введите sudo перед командой следующим образом:

```shell
sudo command_to_run
```

### И что теперь?
Теперь у вас есть надежное основание для вашего сервера. Вы можете переходить к установке программного обеспечения, которое требуется на вашем сервере.

## Установка Spark
### Установка необходимых пакетов для Spark
Перед загрузкой и настройкой Spark необходимо установить необходимые зависимости - *JDK, Scala, Git.*

Выполните следующую команду, чтобы установить сразу все три пакета:
```shell
sudo apt install default-jdk scala git -y
```
Результат будет следующим:
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/install-jdk.png)

После завершения процесса проверьте установленные зависимости, выполнив следующие команды:
```shell
java -version; javac -version; scala -version; git --version
```
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/verify-versions.png)

### Загрузиа и настройка Spark на Ubuntu
Теперь вам нужно загрузить нужную версию Spark с их веб-сайта. 
Используйте команду wget и прямую ссылку для загрузки архива Spark:
```shell
wget https://downloads.apache.org/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz
```

Когда загрузка завершится, вы увидите сообщение:
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/wget-spark-install.png)

Теперь распакуйте сохраненный архив с помощью tar:
```shell
tar xvf spark-*
```
Пусть процесс завершится. Вывод показывает файлы, которые распаковываются из архива.
После завершения процесса, на экране появятся список файлов, которые распаковали. Теперь нужно переместить распакованный каталог spark-3.0.1-bin-hadoop2.7 в каталог opt/spark.
Для этого используйте команду:
```shell
sudo mv spark-3.0.1-bin-hadoop2.7 /opt/spark
```
Терминал не возвращает ответа, если он успешно перемещает каталог. Если вы ошибетесь при вводе имени, вы получите сообщение, похожее на:
```shell
mv: cannot stat 'spark-3.0.1-bin-hadoop2.7': No such file or directory.
```

### Настройка среды Spark
Перед запуском главного сервера необходимо настроить переменные среды. Есть несколько домашних путей Spark, которые необходимо добавить в профиль пользователя.

Используйте команду echo, чтобы добавить эти три строки в .profile:
```shell
echo "export SPARK_HOME=/opt/spark" >> ~/.profile
echo "export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin" >> ~/.profile
echo "export PYSPARK_PYTHON=/usr/bin/python3" >> ~/.profile
```
Вы также можете добавить пути экспорта, отредактировав файл .profile в выбранном вами редакторе, таком как nano или vim.

Например, чтобы использовать nano, введите:
```shell
nano .profile
```
Когда профиль загрузится, прокрутите файл до конца.
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/edit-profile.png)

Затем добавьте эти три строки:
```shell
export SPARK_HOME=/opt/spark
export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin
export PYSPARK_PYTHON=/usr/bin/python3
```
Выйдите и сохраните изменения при появлении запроса.

Когда вы закончите добавлять пути, загрузите файл .profile в командной строке, набрав:
```shell
source ~/.profile
```

### Запуск главного сервера Spark
Теперь, когда вы завершили настройку среды для Spark, вы можете запустить главный сервер.

В терминале введите:
```shell
start-master.sh
```

Чтобы просмотреть пользовательский веб-интерфейс Spark, откройте веб-браузер и введите IP-адрес локального хоста через порт 8080.
```shell
http://127.0.0.1:8080/
```
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/spark-web-ui.png)

URL для Spark Master — это имя вашего устройства на порту 8080. В нашем случае это ubuntu1:8080. Итак, есть три возможных способа загрузки веб-интерфейса Spark Master:
- 127.0.0.1:8080
- localhost:8080
- deviceName:8080

### Запуск рабочего процесса

Мы запустим один подчиненный сервер вместе с главным сервером.

Для этого выполните следующую команду в этом формате:
```shell
start-slave.sh spark://master:port
```
Мастером в команде может быть IP или имя хоста.

В нашем случае это ubuntu1:
```shell
start-slave.sh spark://ubuntu1:7077
```
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/start-slave-spark.png)
Теперь, когда рабочий процесс запущен и работает, если вы перезагрузите веб-интерфейс Spark Master, вы должны увидеть его в списке:
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/spark-workers-alive.png)

### Распределение ресурсов для работы

Настройкой по умолчанию при запуске рабочего процесса на машине является использование всех доступных ядер CPU. Вы можете указать количество ядер, передав флаг -c команде start-slave.

Например, чтобы запустить воркер и назначить ему только одно ядро CPU, введите такую команду:
```shell
start-slave.sh -c 1 spark://ubuntu1:7077
```
Перезагрузите веб-интерфейс Spark Master, чтобы подтвердить конфигурацию рабочего процесса.
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/specify-spark-worker-cpu-cores.png)

### Запуск Spark Shell
После завершения настройки и запуска главного и подчиненного серверов проверьте, работает ли оболочка Spark.

Загрузите оболочку, введя:

```shell
spark-shell
```
Вы должны получить экран с уведомлениями и информацией Spark. Scala — это интерфейс по умолчанию, поэтому оболочка загружается при запуске spark-shell.

![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/spark-shell.png)

Введите :q и нажмите Enter, чтобы выйти из Scala.

### ТЕСТ Python в Spark

Если вы не хотите использовать интерфейс Scala по умолчанию, вы можете переключиться на Python.

Убедитесь, что вы вышли из Scala, а затем выполните эту команду:
```shell
pyspark
```
![](https://phoenixnap.com/kb/wp-content/uploads/2021/04/pyspark-command-shell.png)

### Основные команды для запуска и остановки главного сервера и рабочих процессов
Ниже приведены основные команды для запуска и остановки главного и рабочих серверов Apache Spark. Поскольку эта настройка предназначена только для одной машины, сценарии, которые вы запускаете, по умолчанию относятся к локальному хосту.

```shell
start-master.sh
```

Чтобы остановить главный экземпляр, запущенный выполнением приведенного выше сценария, запустите:
```shell
stop-master.sh
```
Чтобы остановить запущенный рабочий процесс, введите следующую команду:
```shell
stop-slave.sh
```

## ЗАКЛЮЧЕНИЕ
В этом руководстве показано, как установить Spark на компьютер с Ubuntu, а также необходимые зависимости.
